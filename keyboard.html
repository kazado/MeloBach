
<HTML>







	<head>
	
	
	
		<style>
	
	
			
			body {
	
	
	
				background-image: url('https://dm0qx8t0i9gc9.cloudfront.net/thumbnails/video/QIAQ9Rd/white-music-background_njs6jzi3_thumbnail-1080_01.png');
	
	
	
			}
	
	
	
			
	
	
	
			.whitekey{
	
	
	
				background-color:white;
	
	
	
				height:20%;
	
	
	
				width:3%;
	
	
	
				min-width:50px;
	
	
	
				padding-right:20px;
	
	
	
				padding-left:20px;
	
	
	
				padding-top:200px;
	
	
	
				padding-bottom:40px;
	
	
	
				font-size: 25px;
	
	
	
				border-bottom-left-radius:10px;
	
	
	
				border-bottom-right-radius:10px;
	
	
	
				border-top-left-radius:4px;
	
	
	
				border-top-left-radius:4px;
	
	
	
				border-left: 1px;
	
	
	
				border-right: 1px;
	
	
	
				box-shadow: 5px 5px 5px gray;
	
	
	
				display: inline-block;
	
	
	
				position:relative;
	
	
	
				z-index:2;
	
	
	
				
	
	
	
			}
	
	
	
	
	
	
	
			.whitekey:active{
	
	
	
				background-color:aliceblue;
	
	
	
				box-shadow: 5px 5px 5px blue;
	
	
	
			}
	
	
	
	
	
	
	
			.blackkey{
	
	
	
				background-color:black;
	
	
	
				height:15%;
	
	
	
				width:2%;
	
	
	
				min-width:30px;
	
	
	
				padding-right:2px;
	
	
	
				padding-left:2px;
	
	
	
				padding-top:100px;
	
	
	
				padding-bottom:20px;
	
	
	
				font-size: 25px;
	
	
	
				border-bottom-left-radius:8px;
	
	
	
				border-bottom-right-radius:8px;
	
	
	
				border-top-left-radius:4px;
	
	
	
				border-top-left-radius:4px;
	
	
	
				border-left: 1px;
	
	
	
				border-right: 1px;
	
	
	
				box-shadow: 5px 5px 5px gray;
	
	
	
				display: inline-block;
	
	
	
				color: white;
	
	
	
				position:absolute;
	
	
	
				z-index:3;
	
	
	
				margin-left: -1.25%;
	
	
	
				
	
	
	
			}
	
	
	
	
	
	
	
			.blackkey:active{
	
	
	
				background-color:#151b54;
	
	
	
				box-shadow: 5px 5px 5px blue;
	
	
	
			}
	
	
	
	
	
	
	
			.newImage{
	
	
	
				position:absolute;
	
	
	
				z-index: -1;
	
	
	
			}
	
	
	
	
	
	
	
			.button{
	
				background: linear-gradient(to bottom, #f5ebd97e, #7b7d8d);
				box-shadow: 2px 2px 4px rgba(212, 164, 75, 0.603);

	
				background-color: white; 
	
	
	
	  color: black;
	
	
	
	  padding: 10px 20px; 
	
	
	
	  border: 5px; 
	
	
	
	  border-radius: 10px;

	  border-color: #000;
	
	
	
	  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
	
	
	
	  font-size: 100;
	
	
	
	  height: 60px;
	
	
	
	  width: 100px;
	
	
	
	  align-items:baseline;
	
	
	
	  display: inline-block;
	
	
	
	  cursor: pointer;
	
	
	
	  transition: background-color 0.3s ease, color 0.3s ease;
	
	
	
	  opacity: 0.9;
	  
	
	
	
			}
	
	
	
	
	
	
	
			.button1{
	
	
	
				
				background-color: white; 
	
	
				background: linear-gradient(to bottom, #f5ebd97e, #7b7d8d);
				box-shadow: 2px 2px 4px rgba(212, 164, 75, 0.603);

	  color: black;
	
	
	
	  padding: 10px 30px; 
	
	
	
	  border: 5px; 
	
	
	
	  border-radius: 10px;
	
	
	
	  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
	
	
	
	  font-size: 100;
	
	
	
	  height: 60px;
	
	
	
	  width: 100px;
	
	
	
	  align-items:baseline;
	
	
	
	  display: inline-block;
	
	
	
	  cursor: pointer;
	
	
	
	  transition: background-color 0.3s ease, color 0.3s ease;
	
	
	
	  opacity: 0.9;
	
	
	
			}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
			.button:hover {
	
	
	
	  background-color: #2980b9;
	
	
	
	}
	
	
	
			.button1:hover {
	
	
	
	  background-color: #2980b9;
	
	
	
	}
	
	
	
	
	

	
	
	
	
	
	
	
			.audioGroup button{
	
	
	
				float:left;
	
	
	
			}
	
	
	
	
	
	
	
			.audioGroup:after{
	
	
	
				content:"";
	
	
	
				clear:both;
	
	
	
				display:table;
	
	
	
			}



			.button2{
				background: linear-gradient(to bottom, #f5ebd97e, #7b7d8d);
				box-shadow: 2px 2px 4px rgba(212, 164, 75, 0.603);

				display: inline-block;
  padding: 10px 20px;
  background-color: gray;
  color: #ffffff;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  transition: background-color 0.3s ease;
  
}



/* Hover effect */
.button2:hover {
  background-color: #2980b9;
}

.audio-player {
  width: 300px;
  background-color: #f5f5f5;
  border: 1px solid #ddd;
  border-radius: 5px;
  padding: 10px;
  text-align: center;
}

/* Style the audio controls */
audio {
  width: 100%;
}

/* Style the play/pause button */
audio::-webkit-media-controls-play-button,
audio::-webkit-media-controls-pause-button,
audio::-webkit-media-controls-play-button:hover,
audio::-webkit-media-controls-pause-button:hover {
  background-color: #0074d9;
  color: white;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  cursor: pointer;
}

/* Style the volume slider */
audio::-webkit-media-controls-volume-slider {
  width: 100%;
}

/* Style the volume slider track */
audio::-webkit-media-controls-volume-slider::-webkit-slider-runnable-track {
  background-color: #ddd;
  height: 4px;
}

/* Style the volume slider thumb */
audio::-webkit-media-controls-volume-slider::-webkit-slider-thumb {
  background-color: #0074d9;
  width: 12px;
  height: 12px;
  border: 2px solid white;
  margin-top: -4px; /* Align with the track */
}

.logo img {
    width: 400px; /* Adjust the width as needed */
    height: auto; /* Maintain aspect ratio */
}
/* styles.css */
.info-button {
    position: relative;
    display: inline-block;
}

.info-icon {
    background-color: #71a4c5;
    color: #ffffff;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 20px;
    cursor: pointer;
}

.info-tooltip {
    display: none;
    position: absolute;
    background-color: #71a4c5;
    color: #fff;
    padding: 10px;
    border-radius: 5px;
    top: -150px; /* Adjust the positioning as needed */
    left: 0;
    width: 150px;
    text-align: center;
	z-index: 3;
}

.info-tooltip1 {
    display: none;
    position: absolute;
    background-color: #71a4c5;
    color: #fff;
    padding: 10px;
    border-radius: 5px;
    top: -170px; /* Adjust the positioning as needed */
    left: 0;
    width: 150px;
    text-align: center;
	z-index: 3;
}

.info-tooltip2 {
    display: none;
    position: absolute;
    background-color: #71a4c5;
    color: #fff;
    padding: 10px;
    border-radius: 5px;
    top: -50px; /* Adjust the positioning as needed */
    left: 0;
    width: 150px;
    text-align: center;
	z-index: 3;
}

.info-button:hover .info-tooltip {
    display: block;
}
.info-button:hover .info-tooltip1 {
    display: block;
}
.info-button:hover .info-tooltip2 {
    display: block;
}

.logo {
	
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 40%;

}
	
	
	
		</style>
	
	
	
	</head>
	<header>
        <div class="logo">
            <img src="logo.png">
        </div>
    </header>
	
	
	<body onLoad="load()">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<div>
	
	
	
		
	
	
	
	</div>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<canvas id="inputCanvas" width="1400" height="800" style ="border:1px solid #000" onmousemove="getPosition(event)" onclick="getClickedPosition(event)" ></canvas>
	<div class="info-button">
        <button class="info-icon">&#128712</button>
        <div class="info-tooltip">
            <p>Click on the staff to place musical notes. The staff represents the musical score where you will interact with your compositions.</p>
        </div>
    </div>
	
	<div>
	
	
	
		<button type="button" onclick="setNoteDuration('w')" class="button1"><img src="https://www.bethsnotesplus.com/wp-content/uploads/2012/10/whole-note-icon-250.png" height="40px" width="45px"></button>
	
	
	
		<button type="button" onclick="setNoteDuration('h')" class="button1"><img src="https://www.bethsnotesplus.com/wp-content/uploads/2012/10/half-note-icon-200.png" height="40px" width="55px"></button>
	
	
	
		<button type="button" onclick="setNoteDuration('q')" class="button1"><img src="https://www.bethsnotesplus.com/wp-content/uploads/2023/09/quarter-note-musisync-90x300.png" height="40px" width="13px"></button>
	
	
	
		<button type="button" onclick="setNoteDuration('e')" class="button1"><img src="kisspng-musical-note-portable-network-graphics-clip-art-im-music-notes-png-vector-clipart-psd-peoplepng-c-5cf6824db1dae8.1166474915596590857285.png" height="40px" width="40px"></button>
	
	
	
		<button type="button" onclick="setNoteDuration('s')" class="button1"><img src="kisspng-musical-note-sixteenth-note-vector-graphics-portab-file-semiquaver-music-svg-wikimedia-commons-musics-5d1426c212ce82.870163441561601730077.png" height="40px" width="20px"></button>
	
	
	
		<button onclick="setAccidental('b')" style="font-size: 35px;" class="button" >&#x266d</button>
	
	
	
		<button onclick="setAccidental('n')" style="font-size: 35px;" class="button">&#x266e</button>
	
	
	
		<button onclick="setAccidental('#')" style="font-size: 40.5px;" class="button">&#x266f</button>
	
	
	
		<button onclick="refreshInput()" style="font-size: 40.5px;" class="button2">CLEAR</button>
	
	
	
		<button onclick="loadTrainingData()" style="font-size: 40.5px;" class="button2">SUBMIT</button>

		<button onclick="playChordsWithPause();" style="font-size: 40.5px;" class="button2">PLAY</button>
		<button class = "button2" style="font-size: 40.5px;" id="convertButton" >DOWNLOAD</button>
	


	
	
	</div>
	
	
	<div class="info-button">
        <button class="info-icon">&#128712</button>
        <div class="info-tooltip1">
			Click on the piano keyboard to select musical notes. The accidental buttons allow you to choose sharps and flats, and the note length buttons control the duration of the notes.</p>
		</div>
    </div>
	
	
	
	
	<br>
	<title>MeloBach</title>
	
	
	<div style="background-color:black ; overflow-x:visible ; overflow-y:hidden; white-space: nowrap;">
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('A2')">A</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Bb2')">Bb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('B2')">B</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('C3')">C</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Db3')">Db</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('D3')">D</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Eb3')">Eb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('E3')">E</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('F3')">F</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Gb3')">Gb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('G3')">G</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Ab3')">Ab</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('A3')">A</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Bb3')">Bb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('B3')">B</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('C4')">C</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Db4')">Db</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('D4')">D</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Eb4')">Eb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('E4')">E</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('F4')">F</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Gb4')">Gb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('G4')">G</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Ab4')">Ab</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('A4')">A</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Bb4')">Bb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('B4')">B</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('C5')">C</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Db5')">Db</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('D5')">D</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Eb5')">Eb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('E5')">E</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('F5')">F</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Gb5')">Gb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('G5')">G</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Ab5')">Ab</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('A5')">A</button>
	
	
	
		<button type="button" class="blackkey" onclick="noteClicked('Bb5')">Bb</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('B5')">B</button>
	
	
	
		<button type="button" class="whitekey" onclick="noteClicked('C6')">C</button>
	
	
	
	</div>
	
	
	
	<div class = "audioGroup">
	
	
	  <button onclick="startRecord()" id = "startRecording"><img src="https://cdn-icons-png.flaticon.com/512/4029/4029019.png" height="40px" width="40px"></button>
	
	
	
	
	
	
	
	  <button onclick="stopRecord()" id = "stopRecording"><img src="https://static.thenounproject.com/png/3627403-200.png" height="40px" width="40px"></button>
	
	  <div class="info-button">
        <button class="info-icon">&#128712</button>
        <div class="info-tooltip2">
            <p>Use the audio input feature to record a melody. The app will transcribe it into musical notes on the staff automatically. Explore your creativity with this tool!</p>
        </div>
    </div>
	
	
	  <!-- <button onclick="startPitchDetection()">
	
	
	
		Start Pitch Detection
	
	
	
	</button> -->
	
	
	
	  <button onclick="startPlayback()" id = "startPlayback"><img src="play-button-icon-png-18904.png" height="40px" width="40px"></button>
	
	
	
	
	
	
	
	  <button onclick="stopPlayback()" id = "stopPlayback"><img src="pause-button-png-29655.png" height="40px" width="40px"></button>
	
	
	
	
	
	
	
	
	
	
	
	  <!-- <button onclick="submit()" id = "submit">Submit Recording</button> -->
	
	
	
	
	
	
<br>
<br>
<br>

	
<audio class = "audio-Player" id = "audioPlayer" controls></audio>
	
	
	
</div>



<script type ="text/javascript" src="https://code.jquery.com/jquery.min.js"></script>
<body>
    

    <script src="./midiwriter.js"></script>
</body>
<script>
function convertBeatstoNotes(beats) {
	var notes = [];
	for (var i = 0; i < beats.length; i++) {
		notes.push(beats[i][0]['name']);
	
	}
	
	return notes;
}
function convertBeatstoDurations(beats) {
	var durations = [];
	for (var i = 0; i < beats.length; i++) {
		durations.push(String(16/durationToSixteenthCount(beats[i][0]['duration'])));
		console.log(durations)
	}
	
	return durations;
}
document.getElementById("convertButton").addEventListener("click", function () {
    // Define an array of notes (e.g., ["C4", "E4", "G4"])
   
	var notes = convertBeatstoNotes(beats);
	var durations = convertBeatstoDurations(beats);
    convertToMidi(notes, durations);
});
function convertToMidi(notes, durations) {
    // Create a new MidiWriter object
    var track = new MidiWriter.Track();

    // Define instrument and tempo
    track.addEvent(new MidiWriter.ProgramChangeEvent({ instrument: 1 }));
    track.setTempo(120);

    // Add notes to the track
    for (var i = 0; i < notes.length; i++) {
        track.addEvent(new MidiWriter.NoteEvent({ pitch: notes[i], duration: durations[i]}));
    }

    // Create a new MidiWriter.Writer object
    var writer = new MidiWriter.Writer([track]);

    // Get the MIDI data as a Uint8Array
    var byteArray = writer.buildFile();

    // Convert Uint8Array to Blob
    var blob = new Blob([byteArray], { type: 'audio/midi' });

    // Create a download link
    var downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = 'output.mid';

    // Append the link to the DOM and trigger the click event
    document.body.appendChild(downloadLink);
    downloadLink.click();

    // Remove the link from the DOM
    document.body.removeChild(downloadLink);
}
</script>

<script>


		
	
	
	
		
	
	
	
		let audioChunks = [];
	
	
	
		
	
	
	
		let mediaRecorder;
	
	
	
		
	
	
	
		const button1 = document.getElementById("startRecording");
	
	
	
		
	
	
	
		const button2 = document.getElementById("stopRecording");
	
	
	
		
	
	
	
		const button3 = document.getElementById("startPlayback");
	
	
	
		
	
	
	
		const button4 = document.getElementById("stopPlayback");
	
	
	
		
	
	
	
	
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		button1.style.display = "block";
	
	
	
		
	
	
	
		button2.style.display = "none";
	
	
	
		
	
	
	
		button3.style.display = "block";
	
	
	
		
	
	
	
		button4.style.display = "none";
	
	
	
		
	
	
	
	
	
	
	
		function LAlgorithm(inputArray, existingSequences) {
	
	
	
		var closestSequence = null;
	
	
	
		var closestDistance = Infinity;
	
	
	
		for (let i = 0; i < existingSequences.length; i++) {
	
	
	
			const existingSequence = existingSequences[i];
	
	
	
			const distance = findDistance(existingSequence, inputArray);
	
	
	
			if (distance < closestDistance) {
	
	
	
				closestDistance = distance;
	
	
	
				closestSequence = existingSequence;
	
	
	
			} 
	
	
	
		}
	
	
	
		return closestSequence;
	
	
	
	}
	
	
	
	// var audioCtx = new AudioContext();
	
	
	
	let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
	
	
	
	
	
	
	
		let analyserNode = audioCtx.createAnalyser()
	
	
	
		let audioData = new Float32Array(analyserNode.fftSize);
	
	
	
		let corrolatedSignal = new Float32Array(analyserNode.fftSize);
	
	
	
		let localMaxima = new Array(10);
	
	
	
		const frequencyDisplayElement = document.querySelector('#frequency');
	
	
	
		let microphoneStream = null;
	
	
	
		var pitchDetectionCounter = 0;
	
	
	
		let pitchDetectionInterval = null;

		let max = 2000;
		let samples = 10;
		let sampleInterval = 500;
	
	
	
	
	const startRecording = document.querySelector('#startRecording');
	
	startRecording.addEventListener('click', () => {
		audioCtx.resume().then(() => {
			// AudioContext is now active and can be used.
		});
		
	});
	const myButton = document.getElementById("startRecording");

// Add an event listener to the button
myButton.addEventListener("click", function () {
  // Call multiple functions when the button is clicked
  startPitchDetection();
  startRecord();
});
	
		function startPitchDetection() {
	
			//pitchDeetectionCounter = 0;
	
			//refreshInput();
	
	
	
		if (pitchDetectionCounter < samples) {
	
	
	
				try {
	
	
	
					microphoneStream = navigator.mediaDevices.getUserMedia({ audio: true })
	
	
	
						.then((stream) => {
	
	
	
							const microphoneSource = audioCtx.createMediaStreamSource(stream);
	
	
	
							microphoneSource.connect(analyserNode);
	
	
	
	
	
	
	
							audioData = new Float32Array(analyserNode.fftSize);
	
	
	
							corrolatedSignal = new Float32Array(analyserNode.fftSize);
	
	
	
	
	
	
	
							pitchDetectionInterval = setInterval(() => {
	
	
	
								analyserNode.getFloatTimeDomainData(audioData);
	
	
	
	
	
								let pitch = getAutocorrolatedPitch().toFixed(2);
	
	
	
								console.log(pitch);
	
	
	
								var note = frequencyToNote(pitch, max);
	
								console.log(note);
	

								if (pitch < max) {
									pitchDetectionCounter++;
									beats.push([new Note(note, "q")]);
	
	
	
						
	
	
	
									drawNotes();
								}
								
							
	
	
	
	
	
								if (pitchDetectionCounter > samples) {
	
	
	
									clearInterval(pitchDetectionInterval);
	
	
	
								}
	
	
	
								
	
	
	
							
	
	
	
	
	
	
								
	
	
	
							}, sampleInterval);
	
	
	
						})
	
	
	
						.catch((err) => {
	
	
	
							
	
	
	
						});
	
	
	
				} catch (error) {
	
	
	
					
	
	
	
				}
	
	
	
			}
	
	
	
		}
	
	
	
	
	
	
	
		function getAutocorrolatedPitch()
	
	
	
		{
	
	
	
			// First: autocorrolate the signal
	
	
	
	
	
	
	
			let maximaCount = 0;
	
	
	
	
	
	
	
			for (let l = 0; l < analyserNode.fftSize; l++) {
	
	
	
				corrolatedSignal[l] = 0;
	
	
	
				for (let i = 0; i < analyserNode.fftSize - l; i++) {
	
	
	
					corrolatedSignal[l] += audioData[i] * audioData[i + l];
	
	
	
				}
	
	
	
				if (l > 1) {
	
	
	
					if ((corrolatedSignal[l - 2] - corrolatedSignal[l - 1]) < 0
	
	
	
						&& (corrolatedSignal[l - 1] - corrolatedSignal[l]) > 0) {
	
	
	
						localMaxima[maximaCount] = (l - 1);
	
	
	
						maximaCount++;
	
	
	
						if ((maximaCount >= localMaxima.length))
	
	
	
							break;
	
	
	
					}
	
	
	
				}
	
	
	
			}
	
	
	
	
	
	
	
			// Second: find the average distance in samples between maxima
	
	
	
	
	
	
	
			let maximaMean = localMaxima[0];
	
	
	
	
	
	
	
			for (let i = 1; i < maximaCount; i++)
	
	
	
				maximaMean += localMaxima[i] - localMaxima[i - 1];
	
	
	
	
	
	
	
			maximaMean /= maximaCount;
	
	
	
	
	
	
	
			return audioCtx.sampleRate / maximaMean;
	
	
	
		}
	
	
	
	function findDistance(sequenceA, sequenceB) {
	
	
	
		const m = sequenceA.length;
	
	
	
		const n = sequenceB.length;
	
	
	
		const dp = [];
	
	
	
		for (let i = 0; i <= m; i++){
	
	
	
			dp[i] = [];
	
	
	
			dp[i][0] = i;
	
	
	
		}
	
	
	
		for (let j = 0; j <= n; j++){
	
	
	
			dp[0][j] = j;
	
	
	
		}
	
	
	
		for (i = 1; i <= m; i++) {
	
	
	
			for (j = 1; j <= n; j++) {
	
	
	
				const cost = sequenceA[i - 1] === sequenceB[j - 1] ? 0 : 1;
	
	
	
				dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + cost);
	
	
	
			}
	
	
	
		}
	
	
	
		return dp[m][n];
	
	
	
	}
	
	
	
	function playChordsWithPause() {
	
			let index = 0;
			var pauseDuration;
			
	
			function playNextChord() {
	
			
	
				if (index < beats.length) {
	
					for (var i = 0; i < beats[index].length; i++) {
	
						var name = beats[index][i]["name"];
	
						
						if (name.substring(1,2) == "#") {
							console.log(name.substring(0,2));
							name = sharpToFlat(name.substring(0,2)) + name.substring(2,3);
						}
						pauseDuration = durationToSixteenthCount(beats[index][i]["duration"]) * 250;

						console.log(name);
	
						const audioElement = new Audio(name + ".mp3");
	
						audioElement.play();
	
						}
	
						
	
						
	
					}
	
	
	
					index++;
	
					setTimeout(playNextChord, pauseDuration);
	
					
	
				}
				playNextChord();
	
			}
	
	
	
			
	function sharpToFlat(note) {
  const notesWithSharps = ["C#", "D#", "F#", "G#", "A#"];
  const notesWithFlats = ["Db", "Eb", "Gb", "Ab", "Bb"];

  for (let i = 0; i < notesWithSharps.length; i++) {
    if (note == notesWithSharps[i]) {
      return notesWithFlats[i];
    }
  }

  return note;
}

		
	
	
	
function loadTrainingData() {
	
	
	
			 
	
	
	
	// Sample JSON data



	$.getJSON("ChordGetterJSON.json", function(jsonData) {






// const targetNotes = beats;//['C', 'E', 'G']; 



console.log(beats);





var targetNotes = [];



for (var i = 0; i < beats[0].length; i++) {



   targetNotes.push(beats[0][i]["name"].replace(/[0-9]/g,""));



}



var chords = [];



 for (var i = 0; i < jsonData.length; i++) {



chords.push(jsonData[i]['chords']);



 }



 const closestMatch = findClosestMatch(targetNotes, chords);







// console.log(closestMatch);



const trimMatched = trimToSixteen(targetNotes, closestMatch);



console.log(trimMatched);



for (var i = 0; i < trimMatched.length; i++){



const note = trimMatched[i];



for (var j = 0; j < note.length; j++){



   // if (beats.length <= trimMatched.length) {



	   // noteName = 



	   // if (!note.includes(beats[i][0]["name"].replace(/[0-9]/g,""))) {



		   // console.log(beats[i][0]);



		   if (beats.length <= i){



			   beats.push([]);



		   }



		   var oct = Math.floor(Math.random()*5)+2;



		   console.log(oct);



		   beats[i].push(new Note(note[j] + oct.toString(), "q"));



	   // }



   // }



}



}
	
	
	
	
	
	playChordsWithPause();
	
	
	
	for (var i = 0; i < beats.length; i++) {
	
	
	
		for (var j = 0; j < beats[i].length - 1; j++){
	
	
	
			
	
	
	
			if (beats[i][j]["name"].substr(0,1) == beats[i][j+1]["name"].substr(0,1)) {
	
	
	
				var randomNum = Math.floor(Math.random() * 2);
	
	
	
				if (randomNum == 0){
	
	
	
					beats[i].slice(j);
	
	
	
				} else {
	
	
	
					beats[i].slice(j+1);
	
	
	
				}
	
	
	
				
	
	
	
				
	
	
	
			}
	
	
	
		}
	
	
	
	}
	
	console.log(beats);
	
	drawNotes();
	
	
	
		  });
	
	
	
		  
	
	
	
	}
	
	
	
	 
	
	
	
	
	
	
	
	function trimToSixteen(inputArray, closestSequence){
	
	
	
		var trimmedNotes = [];
	
	
	
		var scores = [];
	
	
	
		console.log(inputArray);
	
	
	
		console.log(closestSequence.length - inputArray.length);
	
	
	
		for (var i = 0; i < closestSequence.length - inputArray.length; i++) {
	
	
	
			score = 0;
	
	
	
			const sequenceSubsection = closestSequence.slice(i,i+inputArray.length);
	
	
	
			for (var j = 0; j < inputArray.length; j++) {
	
	
	
			const targetNote = inputArray[j];
	
	
	
			const matchedBeat = sequenceSubsection[j];
	
	
	
			if (matchedBeat.includes(targetNote)){
	
	
	
				score++;
	
	
	
			}
	
	
	
			
	
	
	
			}
	
	
	
			scores.push(score);
	
	
	
		}
	
	
	
		
	
	
	
		let max = scores[0];
	
	
	
		let maxIndex = 0;
	
	
	
		for (var i = 0; i < scores.length; i++) {
	
	
	
			if (scores[i] > max) {
	
	
	
				max = scores[i];
	
	
	
				maxIndex = i;
	
	
	
			}
	
	
	
		}
	
	
	
		return closestSequence.slice(maxIndex, 16+inputArray.length);
	
	
	
		
	
	
	
	}
	
	
	
	   function findClosestMatch(targetNotes, arrayOfSongs) {
	
	
	
	  let closestMatchIndex = -1;
	
	
	
	  let closestMatchDistance = Infinity;
	
	
	
	
	
	
	
	  for (let i = 0; i < arrayOfSongs.length; i++) {
	
	
	
		const currentSong = arrayOfSongs[i];
	
	
	
		const distance = calculateDistance(targetNotes, currentSong);
	
	
	
	
	
	
	
		if (distance < closestMatchDistance) {
	
	
	
		  closestMatchDistance = distance;
	
	
	
		  closestMatchIndex = i;
	
	
	
		}
	
	
	
	  }
	
	
	
	
	
	
	
	  if (closestMatchIndex === -1) {
	
	
	
		return null; // No match found
	
	
	
	  }
	
	
	
	
	
	
	
	  return arrayOfSongs[closestMatchIndex];
	
	
	
	}
	
	
	
	
	
	
	
	function calculateDistance(a, b) {
	
	
	
	  const m = a.length;
	
	
	
	  const n = b.length;//current song length
	
	
	
	
	
	
	
	  if (m === 0) return n;
	
	
	
	  if (n === 0) return m;
	
	
	
	
	
	
	
	  const dp = [];
	
	
	
	
	
	
	
	  for (let i = 0; i <= m; i++) {
	
	
	
		dp[i] = [i];
	
	
	
	  }
	
	
	
	
	
	
	
	  for (let j = 1; j <= n; j++) {
	
	
	
		dp[0][j] = j;
	
	
	
	  }
	
	
	
	
	
	
	
	  for (let i = 1; i <= m; i++) {
	
	
	
		for (let j = 1; j <= n; j++) {
	
	
	
		  //const cost = a[i - 1] === b[j - 1] ? 0 : 1;
	
	
	
			 const cost = b[j - 1].includes(a[i - 1]) ? 0 : 1;
	
	
	
		  dp[i][j] = Math.min(
	
	
	
			dp[i - 1][j] + 1,
	
	
	
			dp[i][j - 1] + 1,
	
	
	
			dp[i - 1][j - 1] + cost
	
	
	
		  );
	
	
	
		}
	
	
	
	  }
	
	
	
	
	
	
	
	  return dp[m][n];
	
	
	
	}
	
	
	
	
	
	
	
		function frequencyToNote(frequency, threshold){
	
	
	
			if (frequency == NaN) {
	
	
	
				return 'C3';
	
	
			}
	
	
	
				const noteValues = [['A0', 27.50], ['A#0', 29.14], ['B0', 30.87],
	
	
	
			['C1', 32.70], ['C#1', 34.65], ['D1', 36.71], ['D#1', 38.89], ['E1', 41.20], ['F1', 43.65],
	
	
	
			['F#1', 46.25], ['G1', 49.00], ['G#1', 51.91], ['A1', 55.00], ['A#1', 58.27], ['B1', 61.74],
	
	
	
			['C2', 65.41], ['C#2', 69.30], ['D2', 73.42], ['D#2', 77.78], ['E2', 82.41], ['F2', 87.31],
	
	
	
			['F#2', 92.50], ['G2', 98.00], ['G#2', 103.83], ['A2', 110.00], ['A#2', 116.54], ['B2', 123.47],
	
	
	
			['C3', 130.81], ['C#3', 138.59], ['D3', 146.83], ['D#3', 155.56], ['E3', 164.81], ['F3', 174.61],
	
	
	
			['F#3', 185.00], ['G3', 196.00], ['G#3', 207.65], ['A3', 220.00], ['A#3', 233.08], ['B3', 246.94],
	
	
	
			['C4', 261.63], ['C#4', 277.18], ['D4', 293.66], ['D#4', 311.13], ['E4', 329.63], ['F4', 349.23],
	
	
	
			['F#4', 369.99], ['G4', 392.00], ['G#4', 415.30], ['A4', 440.00], ['A#4', 466.16], ['B4', 493.88],
	
	
	
			['C5', 523.25], ['C#5', 554.37], ['D5', 587.33], ['D#5', 622.25], ['E5', 659.25], ['F5', 698.46],
	
	
	
			['F#5', 739.99], ['G5', 783.99], ['G#5', 830.61], ['A5', 880.00], ['A#5', 932.33], ['B5', 987.77],
	
	
	
			['C6', 1046.50], ['C#6', 1108.73], ['D6', 1174.66], ['D#6', 1244.51], ['E6', 1318.51],
	
	
	
			['F6', 1396.91], ['F#6', 1479.98], ['G6', 1567.98], ['G#6', 1661.22], ['A6', 1760.00],
	
	
	
			['A#6', 1864.66], ['B6', 1975.53], ['C7', 2093.00], ['C#7', 2217.46], ['D7', 2349.32],
	
	
	
			['D#7', 2489.02], ['E7', 2637.02], ['F7', 2793.83], ['F#7', 2959.96], ['G7', 3135.96],
	
	
	
			['G#7', 3322.44], ['A7', 3520.00], ['A#7', 3729.31], ['B7', 3951.07], ['C8', 4186.01],
	
	
	
			['C#8', 4434.92], ['D8', 4698.63], ['D#8', 4978.03], ['E8', 5274.04], ['F8', 5587.65],
	
	
	
			['F#8', 5919.91], ['G8', 6271.93], ['G#8', 6644.88], ['A8', 7040.00], ['A#8', 7458.62],
	
	
	
			['B8', 7902.13]];
	
	
	
				if (frequency >threshold) {
	
	
	
					return false;
	
	
	
				}
	
	
	
				var note = noteValues[0][0];
	
	
	
				var min = Math.abs(noteValues[0][1] - frequency);
	
	
	
				for (var i = 1; i < noteValues.length; i++) {
	
	
	
					if (Math.abs(noteValues[i][1] - frequency) < min) {
	
	
	
						min = Math.abs(noteValues[i][1] - frequency);
	
	
	
						note = noteValues[i][0];
	
	
	
					}
	
	
	
				}
	
	
	
				return note; 
	
	
	
		
	
	
	
			}
	
	
	
		
	
	
	
		function applyFourierTransform(audioData) {
	
	
	
		
	
	
	
		  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  return new Promise((resolve, reject) => {
	
	
	
		
	
	
	
			audioContext.decodeAudioData(audioData, resolve, reject);
	
	
	
		
	
	
	
		  }).then(audioBuffer => {
	
	
	
		
	
	
	
			const source = audioContext.createBufferSource();
	
	
	
		
	
	
	
			source.buffer = audioBuffer;
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
			const analyzer = audioContext.createAnalyser();
	
	
	
		
	
	
	
			analyzer.fftSize = 2048;
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
			source.connect(analyzer);
	
	
	
		
	
	
	
			analyzer.connect(audioContext.destination);
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
			const bufferLength = analyzer.frequencyBinCount;
	
	
	
		
	
	
	
			const frequencyData = new Float32Array(bufferLength);
	
	
	
		
	
	
	
			analyzer.getFloatFrequencyData(frequencyData);
	
	
	
			console.log(frequencyData);
	
	
	
		
	
	
	
		
	
	
	
			return frequencyData;
	
	
	
		
	
	
	
		  }).catch(error => {
	
	
	
		
	
	
	
			console.error("Error decoding audio data:", error);
	
	
	
		
	
	
	
			throw error;
	
	
	
		
	
	
	
		  });
	
	
	
		
	
	
	
		}
	
	
	
		
	
	
	
		function findLevels(identifiedFrequencies, tolerance){
	
	
	
			const levels = [];
	
	
	
			var currentPlateau = [];
	
	
	
			var percentTolerance = 0;
	
	
	
			for (var i = 0; identifiedFrequencies.length; i++){
	
	
	
				const frequency = identifiedFrequencies[i];
	
	
	
				percentTolerance = frequency * (tolerance/100);
	
	
	
				if (Math.abs(frequency-identifiedFrequencies[i-1]) <= percentTolerance) {
	
	
	
					currentPlateau.push(frequency);
	
	
	
				} else {
	
	
	
					if (currentPlateau.length > 2) {
	
	
	
						var total = 0;
	
	
	
		for(var j = 0; j < currentPlateau.length; j++) {
	
	
	
			total += currentPlateau[j];
	
	
	
		}
	
	
	
		var average = total / currentPlateau.length;
	
	
	
						levels.push(average);
	
	
	
					}
	
	
	
					currentPlateau = [frequency];
	
	
	
				}
	
	
	
				return levels;
	
	
	
			}
	
	
	
			
	
	
	
		}
	
	
	
		
	
	
	
		function identifyFrequencies(frequencyData, threshold) {
	
	
	
		
	
	
	
		  const frequencies = [];
	
	
	
		
	
	
	
		  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
	
	
	
		
	
	
	
		  const analyzer = audioContext.createAnalyser();
	
	
	
		
	
	
	
		  analyzer.fftSize = 2048;
	
	
	
		
	
	
	
		  const sampleRate = audioContext.sampleRate;
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  for (let i = 0; i < frequencyData.length; i++) {
	
	
	
		
	
	
	
			const frequency = i * (sampleRate / analyzer.fftSize);
	
	
	
		
	
	
	
			const amplitude = Math.abs(frequencyData[i]);
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
			if (amplitude > threshold) {
	
	
	
		
	
	
	
			  frequencies.push(frequency);
	
	
	
		
	
	
	
			}
	
	
	
		
	
	
	
		  }
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  return frequencies;
	
	
	
		
	
	
	
		}
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		function startRecord() {
	
	
	
		
	
	
	
		  navigator.mediaDevices.getUserMedia({ audio: true })
	
	
	
		
	
	
	
			.then(function (stream) {
	
	
	
		
	
	
	
			  mediaRecorder = new MediaRecorder(stream);
	
	
	
		
	
	
	
			  audioChunks = []; // Reset the audioChunks array
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
			  mediaRecorder.addEventListener("dataavailable", function (event) {
	
	
	
		
	
	
	
				audioChunks.push(event.data);
	
	
	
		
	
	
	
			  });
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
			  mediaRecorder.start();
	
	
	
		
	
	
	
			})
	
	
	
		
	
	
	
			.catch(function (error) {
	
	
	
		
	
	
	
			  console.error("Error accessing device", error);
	
	
	
		
	
	
	
			});
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  button1.style.display = "none";
	
	
	
		
	
	
	
		  button2.style.display = "block";
	
	
	
		
	
	
	
		}
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		function startPlayback() {
	
	
	
		
	
	
	
		  if (audioChunks.length === 0) {
	
	
	
		
	
	
	
			return;
	
	
	
		
	
	
	
		  }
	
	
	
		
	
	
	
		  
	
	
	
		
	
	
	
		  const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
	
	
	
		
	
	
	
		  const audioURL = URL.createObjectURL(audioBlob);
	
	
	
		
	
	
	
		  const audioPlayer = document.getElementById("audioPlayer");
	
	
	
		
	
	
	
		  audioPlayer.src = audioURL;
	
	
	
		
	
		 
	
		  audioPlayer.play();
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  button3.style.display = "none";
	
	
	
		
	
	
	
		  button4.style.display = "block";
	
	
	
		
	
	
	
		}
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		function stopPlayback() {
	
	
	
		
	
	
	
		  const audioPlayer = document.getElementById("audioPlayer");
	
	
	
		
	
	
	
		  audioPlayer.pause();
	
	
	
		
	
	
	
		  audioPlayer.currentTime = 0;
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  button3.style.display = "block";
	
	
	
		
	
	
	
		  button4.style.display = "none";
	
	
	
		
	
	
	
		}
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		function stopRecord() {
	
	
	
		
	
	
	
		  if (mediaRecorder && mediaRecorder.state !== "inactive") {
	
	
	
		
	
	
	
			mediaRecorder.stop();
	
	
	
		
	
	
	
		  }
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  button1.style.display = "block";
	
	
	
		
	
	
	
		  button2.style.display = "none";
	
	
	
		
	
	
	

	
	
	
		
	
	
	
		}
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		async function submit() {
	
	
	
			const frequencies = [100, 100, 101, 100, 100, 100, 102, 103, 105, 105, 106, 107, 107, 108, 108];
	
	
	
		  if (audioChunks.length === 0) {
	
	
	
		
	
	
	
			return;
	
	
	
		
	
	
	
		  }
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
	
	
	
		
	
	
	
		  const audioDataURL = URL.createObjectURL(audioBlob);
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  try {
	
	
	
			const audioContext = new (window.AudioContext || window.webkitAudioContext)();
	
	
	
			const audioData = await fetch(audioDataURL).then(response => response.arrayBuffer());
	
	
	
			const audioBuffer = await audioContext.decodeAudioData(audioData);
	
	
	
	
	
	
	
	// Create a source node
	
	
	
	const source = audioContext.createBufferSource();
	
	
	
	source.buffer = audioBuffer;
	
	
	
	
	
	
	
	// Create an AnalyserNode
	
	
	
	const analyser = audioContext.createAnalyser();
	
	
	
	analyser.fftSize = 2048; // Set the FFT size for frequency analysis
	
	
	
	
	
	
	
	// Connect the source to the analyser
	
	
	
	source.connect(analyser);
	
	
	
	analyser.connect(audioContext.destination);
	
	
	
	
	
	
	
	
	
	
	
	source.start();
	
	
	
	
	
	
	
	// Create a Float32Array to store frequency data
	
	
	
	const bufferLength = analyser.frequencyBinCount;
	
	
	
	const dataArray = new Float32Array(bufferLength);
	
	
	
	console.log(dataArray);
	
	
	
		  
	
	
	
			console.log(audioData);
	
	
	
			const frequencyData = await applyFourierTransform(audioData);
	
	
	
			console.log(frequencyData);
	
	
	
			const identifiedFrequencies = identifyFrequencies(frequencyData, 100);
	
	
	
		
	
	
	
			var pFrequencies = findLevels(identifiedFrequencies, 10);
	
	
	
			
	
	
	
			console.log(pFrequencies);
	
	
	
			var notes = []
	
	
	
			for (var i = 0; i < pFrequencies.length; i++) {
	
	
	
				notes.push(frequencyToNote(pFrequencies[i], 7000));
	
	
	
			}
	
	
	
			console.log(notes);
	
	
	
		  } catch (error) {
	
	
	
		
	
	
	
			 console.error("Error processing audio data:", error);
	
	
	
		
	
	
	
		  }
	
	
	
		
	
	
	
		}
	
	
	
		
	
	
	
		
	
	
	
		
	
	
	
		  </script>
	
	
	
	
	
	
	
	<script>
	
	
	
	const LINE_HEIGHT = 1;
	
	
	
	const SPACE_HEIGHT = 10;
	
	
	
	const TREBLE_LEDGER = 3;
	
	
	
	const LINE_WIDTH = 1200;
	
	
	
	const TOP_PADDING = 10;
	
	
	
	const LEFT_PADDING = 50;
	
	
	
	const SIXTEENTH_WIDTH = 18;
	
	
	
	currentDuration = "q";
	
	
	
	noteAccidental = "n";
	
	
	
	var trebleImage = new Image();
	
	
	
	var bassImage = new Image();
	
	
	
	var flatImage = new Image();
	
	
	
	var sharpImage = new Image();
	
	
	
	var beats = [];
	
	
	
	class Note {
	
	
	
		constructor(name, duration) {
	
	
	
			this.name = name;
	
	
	
			this.duration = duration;
	
	
	
		}
	
	
	
	}
	
	
	
	
	
	
	
	function noteClicked(note){
	
		
		

	
		
		audio = note + ".mp3";
		console.log(audio);
		new Audio(audio).play();
	
	
	
		//if (beats.length() == 0) {
	
	
	
		//	beats.push([]);
	
	
	
		//}
	
	
	
		beats.push([new Note(note, currentDuration)]);
	
	
	
		console.log(beats);
	
		
	
		
	
		drawNotes();
	
	
	
	}
	
	
	
	
	
	
	
	function drawStaffLines(){
	
	
	
		var canvas = document.getElementById("inputCanvas");
	
	
	
		var ctx = canvas.getContext("2d");
	
	
	
	
		for (var l = 0; l < 4; l++) {
			for (var i = TREBLE_LEDGER; i < 11 + TREBLE_LEDGER; i++) {
	
	
	
	if (i != TREBLE_LEDGER + 5) {



		ctx.beginPath();



		ctx.moveTo(LEFT_PADDING,TOP_PADDING + (i * (LINE_HEIGHT + SPACE_HEIGHT) + l * 170));



		ctx.lineTo(LEFT_PADDING + LINE_WIDTH,TOP_PADDING + (i * (LINE_HEIGHT + SPACE_HEIGHT) + l * 170));



		ctx.stroke();



	}



}
		}
	
	
		
	
	
	
	
	
	
	
		/*for (var i = 0; i < 3; i++) {
	
	
	
			ctx.beginPath();
	
	
	
			ctx.moveTo(LEFT_PADDING + (i * SIXTEENTH_WIDTH * 16),TOP_PADDING + (TREBLE_LEDGER * (LINE_HEIGHT + SPACE_HEIGHT)));
	
	
	
			ctx.lineTo(LEFT_PADDING + (i * SIXTEENTH_WIDTH * 16),TOP_PADDING + ((TREBLE_LEDGER + 10) * (LINE_HEIGHT + SPACE_HEIGHT)));
	
	
	
			ctx.stroke();
	
	
	
		}*/
	
	
	
	
		for (var i = 0; i < 4; i++) {
			ctx.drawImage(trebleImage, 50, 30 + (i * 170), 40, 70);
	
			ctx.drawImage(bassImage, 58, 103+ (i * 170), 30, 50);

		}
	
	
	
		
		
	
	
	
	

	
	
	
		
	
	
	
	}
	
	
	
	
	
	
	
	function setNoteDuration(duration){
	
	
	
		currentDuration = duration;
	
	
	
	}
	
	
	
	
	
	
	
	function setAccidental(accidental) {
	

	
		flatImage.src = 'flat.png'
	
	
	
		flatImage.onload = () => {
	
	
	
			noteAccidental = accidental;
		
	
	
	
		}
	
	
	
		sharpImage.src = 'sharp.png'
	
	
	
		sharpImage.onload = () => {
	
	
	
			noteAccidental = accidental;
	
	
	
		}

		moteAccidental = accidental;
	
	
	
	}
	
	
	
	
	
	
	
	function drawNote(x,y,duration, accidental, note){
	
	
	
		const element = document.getElementById("inputCanvas");
	
	
	
		ctx = element.getContext("2d");
	
	
	
		ctx.beginPath();
	
	
	
		ctx.arc(x,y,SPACE_HEIGHT/2,0,2*Math.PI,false);
	
	
	
		ctx.lineWidth = 3;
	
	
	
		ctx.stroke();
	
	
	
		switch (note) {
	
	
	
			case "A5":
	
	
	
				ctx.beginPath();
	
	
	
				ctx.moveTo(x - SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT) * 2);
	
	
	
				ctx.lineTo(x + SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT) * 2);
	
	
	
				ctx.stroke();
	
	
	
				break;
	
	
	
			case "B5":
	
	
	
				ctx.beginPath();
	
	
	
				ctx.moveTo(x - SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT) * 2);
	
	
	
				ctx.lineTo(x + SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT) * 2);
	
	
	
				ctx.stroke();
	
	
	
				break;
	
	
	
			case "C6":
	
	
	
				ctx.beginPath();
	
	
	
				ctx.moveTo(x - SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT) * 2);
	
	
	
				ctx.lineTo(x + SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT) * 2);
	
	
	
				ctx.stroke();
	
	
	
				ctx.beginPath();
	
	
	
				ctx.moveTo(x - SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT));
	
	
	
				ctx.lineTo(x + SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT));
	
	
	
				ctx.stroke();
	
	
	
				break;
	
	
	
			case "C4":
	
	
	
				ctx.beginPath();
	
	
	
				ctx.moveTo(x - SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT) * 8);
	
	
	
				ctx.lineTo(x + SPACE_HEIGHT/1.2, TOP_PADDING + (SPACE_HEIGHT + LINE_HEIGHT) * 8);
	
	
	
				ctx.stroke();
	
	
	
				break;
	
	
	
			default:
	
	
	
				break;
	
	
	
	
	
	
	
	
	
	
	
		}
	
	
	
		if (duration == "q" || duration == "e" || duration == "s"){
	
	
	
			ctx.fill();
	
	
	
		}
	
	
	
		if (duration == "h" || duration == "q" || duration == "e" || duration == "s"){
	
	
	
			if ((y > 187.5 && y < 250) || (y < 125)) {
	
	
	
				ctx.beginPath();
	
	
	
				ctx.moveTo(x + SPACE_HEIGHT/2, y);
	
	
	
				ctx.lineTo(x + SPACE_HEIGHT/2, y - 40);
	
	
	
				ctx.stroke();
	
	
	
				if (duration == "e" || duration == "s") {
	
	
	
					ctx.beginPath();
	
	
	
					ctx.arc(x + SPACE_HEIGHT/3 + 2, y - 32, SPACE_HEIGHT/1.5,1.5*Math.PI,0.1*Math.PI,false);
	
	
	
					ctx.stroke();
	
	
	
					if (duration == "s") {
	
	
	
						ctx.beginPath();
	
	
	
						ctx.arc(x + SPACE_HEIGHT/3 + 2, y - 22, SPACE_HEIGHT/1.5,1.5*Math.PI,0.1*Math.PI,false);
	
	
	
						ctx.stroke();
	
	
	
					}
	
	
	
				}
	
	
	
			} else {
	
	
	
				ctx.beginPath();
	
	
	
				ctx.moveTo(x - SPACE_HEIGHT/2, y);
	
	
	
				ctx.lineTo(x - SPACE_HEIGHT/2, y + 40);
	
	
	
				ctx.stroke();
	
	
	
				if (duration == "e" || duration == "s") {
	
	
	
					ctx.beginPath();
	
	
	
					ctx.arc(x - SPACE_HEIGHT/3 - 2, y + 32, SPACE_HEIGHT/1.5,0.5*Math.PI,1.9*Math.PI,true);
	
	
	
					ctx.stroke();
	
	
	
					if (duration == "s") {
	
	
	
						ctx.beginPath();
	
	
	
						ctx.arc(x - SPACE_HEIGHT/3 - 2, y + 22, SPACE_HEIGHT/1.5,0.5*Math.PI,1.9*Math.PI,true);
	
	
	
						ctx.stroke();
	
	
	
					}
	
	
	
				}
	
	
	
			}
	
	
	
			
	
	
	
			if (accidental == "b") {
	
	
	
				ctx.drawImage(flatImage, x - 22, y - 20, 12, 30);
	
	
	
			} else if (accidental == "#") {
	
	
	
				ctx.drawImage(sharpImage, x - 30, y - 20, 20, 35);
	
	
	
			}
	
	
	
		}
	
	
	
	}
	
	
	
	
	
	
	
	function getPosition(event){
	
	
	
		const element = document.getElementById("inputCanvas");
	
	
	
		const X = event.clientX - element.offsetLeft;
	
	
	
		const Y = event.clientY - element.offsetTop;
	
	
	
		
	
	
	
		ctx = element.getContext("2d");
	
	
	
		ctx.clearRect(0,0,element.width,element.height);
	
	
	
		drawStaffLines();
	
	
	
		
	
	
	
		drawNotes();
	
	
	
	
	
	
	
		note = "A2";
	
	
	
		const notes = ["A2", "B2", "C3", "D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5", "E5", "F5", "G5", "A5", "B5", "C6"];
	
	
	
		const positions = []
	
	
	
		for (var i = 0; i < notes.length; i++) {
	
	
	
			positions.push(TOP_PADDING + (SPACE_HEIGHT + i * (LINE_HEIGHT/2 + SPACE_HEIGHT/2)))

	
	
		}
		positions.reverse();
	
		
	
		minDistance = Math.abs(positions[0] - Y);
	
	
	
		for (var i = 0; i < positions.length; i++) {
	
	
	
			if (Math.abs(positions[i] - Y) < minDistance) {
	
	
	
				note = notes[i];
	
				
	
				minDistance = Math.abs(positions[i] - Y);
	
	
	
			}
	
	
	
		}
	
	
	
		drawNote(X,Y,currentDuration, noteAccidental, note);
	
	
	

	
	
	
	}
	
	
	
	
	
	
	
	function getClickedPosition(event){
	
	
	
		const element = document.getElementById("inputCanvas");
	
	
	
		const X = event.clientX - element.offsetLeft;
	
	
	
		const Y = event.clientY - element.offsetTop;
	
	
		
	
	
	
		ctx = element.getContext("2d");
	
	
	
		ctx.clearRect(0,0,element.width,element.height);
	
	
	
		drawStaffLines();
	
	
	
		
	
	
	
		drawNotes();
	
	
	
	
	
	
	
		note = "A2";
	
	
	
		notes = ["A2", "B2", "C3", "D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5", "E5", "F5", "G5", "A5", "B5", "C6"];
	
	
	
		const positions = []
	
	
	
		for (var i = 0; i < notes.length; i++) {
	
	
	
			positions.push(TOP_PADDING + (SPACE_HEIGHT + i * (LINE_HEIGHT/2 + SPACE_HEIGHT/2)))
			positions.push(TOP_PADDING + (SPACE_HEIGHT + i * (LINE_HEIGHT/2 + SPACE_HEIGHT/2)) + 170)
			positions.push(TOP_PADDING + (SPACE_HEIGHT + i * (LINE_HEIGHT/2 + SPACE_HEIGHT/2)) + 170*2)
			positions.push(TOP_PADDING + (SPACE_HEIGHT + i * (LINE_HEIGHT/2 + SPACE_HEIGHT/2)) + 170*3)
			
	
	
	
		}
		notes = notes.flatMap(element => Array(4).fill(element));
	

	
		positions.reverse();
	
	
	
		minDistance = Math.abs(positions[0] - Y);
	
	
	
		for (var i = 0; i < positions.length; i++) {
	
	
	
			if (Math.abs(positions[i] - Y) < minDistance) {
	
	
	
				note = notes[i];
	
	
	
				minDistance = Math.abs(positions[i] - Y);
	
	
	
			}
	
	
	
		}
	
	
	
		var noteName = note;
		
	
		if (noteAccidental == 'b') {
	
	
	
			noteName = noteName.slice(0,1) + "b" + noteName.slice(1);
	
	
	
			console.log(noteName);
	
	
	
		} else if (noteAccidental == '#') {
	
	
	
			noteName = noteName.slice(0,1) + "#" + noteName.slice(1);
	
			console.log(noteName);
	
		} 
		

		
		console.log(noteName);
		
	
		beats.push([new Note(noteName, currentDuration)]);

		
		if (noteAccidental == '#') {
			console.log(noteName.slice(0,2))
			noteName = sharpToFlat(noteName.slice(0,2)) + noteName.slice(2);
		}
	
		if (noteName.slice(0,2) == 'B#') {
			noteName = 'C' + noteName.slice(2); 
		} else if (noteName.slice(0,2) == 'E#') {
			noteName = 'F' + noteName.slice(2); 
		} else if (noteName.slice(0,2) == 'Cb') {
			noteName = 'B' + noteName.slice(2); 
		} else if (noteName.slice(0,2) == 'Fb') {
			noteName = 'E' + noteName.slice(2); 
		}

		console.log(noteName);
		const audioElement = new Audio(noteName + ".mp3");
	
		audioElement.play();
	
		console.log(beats);
		
		
	
		drawNotes();
	
	
	
	}
	
	
	
	
	
	
	
	function load() {
	
	
	
		trebleImage.src = 'treble.svg'
	
	
	
		trebleImage.onload = () => {
	
	
	
			bassImage.src = 'bass.svg'
	
	
	
			bassImage.onload = () => {
	
	
	
				drawStaffLines();
	
	
	
			}
	
	
	
		}
	
	
	
		setAccidental('n');
	
	
	
	}
	
	
	
	
	
	
	
	function drawNotes() {
	
		
	
		const notes = ["A2", "B2", "C3", "D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5", "E5", "F5", "G5", "A5", "B5", "C6"];
	
	
	
		const positions = []
	
	
	
		for (var i = 0; i < notes.length; i++) {
	
	
	
			positions.push(TOP_PADDING + (SPACE_HEIGHT + i * (LINE_HEIGHT/2 + SPACE_HEIGHT/2)))
			
	
	
	
		}
	
	
	
		var currentIndex = 0;
	
	
	
		var totalDuration = 4;
	
	
	
		positions.reverse();
	
	
	
		for (var i = 0; i < beats.length; i++) {
	
	
	
			const currentBeat = beats[i];

			
			
	
			for (var k = 0; k < currentBeat.length; k++){
	
	
	
				for (var j = 0; j < notes.length; j++) {
	
	
					var note = currentBeat[k]["name"].replace('b', '');

					
	
	
					note = note.replace('#', '');
	
	
	
					if (note == notes[j]) {
	
	
						
						currentIndex = j;
						
	
						if (beats.indexOf(currentBeat) > 15 && beats.indexOf(currentBeat) < 31) {
				drawNote(LEFT_PADDING + SIXTEENTH_WIDTH * (totalDuration - 64), positions[currentIndex] + 170, currentBeat[k].duration, accidental, currentBeat[k]);
			} else if (beats.indexOf(currentBeat) > 31 && beats.indexOf(currentBeat) <= 47) {
				drawNote(LEFT_PADDING + SIXTEENTH_WIDTH * (totalDuration - 128), positions[currentIndex] + 170 * 2, currentBeat[k].duration, accidental, currentBeat[k]);
			} else if (beats.indexOf(currentBeat) > 47 && beats.indexOf(currentBeat) <= 63) {
				drawNote(LEFT_PADDING + SIXTEENTH_WIDTH * (totalDuration - 192) - (LINE_WIDTH * 3 - 4 * SIXTEENTH_WIDTH) + SIXTEENTH_WIDTH, positions[currentIndex] + 170 * 3, currentBeat[k].duration, accidental, currentBeat[k]);
			} else {
				drawNote(LEFT_PADDING + SIXTEENTH_WIDTH * totalDuration, positions[currentIndex], currentBeat[k].duration, accidental, currentBeat[k]);
					
			}
						break;
	
	
	
					}
					
	
	
				}
				
				
				
	
	
			
	
	
	
			var accidental = '';
	
	
	
			if (currentBeat[k]["name"].indexOf('b') > -1) {
	
	
	
				accidental = 'b';
	
				
	
	
	
	
			}
	
	
	
			if (currentBeat[k]["name"].indexOf('#') > -1) {
	
	
	
				accidental = '#';
	
	
	
			}
			
		
			
	
	
			
	
	
	
			
	
	
	
			// totalDuration = totalDuration + durationToSixteenthCount(currentBeat[k].duration);
	
	
	
			
	
		}
		totalDuration = totalDuration + durationToSixteenthCount(currentBeat[0]["duration"]);
		}
	
	
	
	
	
	
	
	}
	
	
	
	
	
	
	
	function durationToSixteenthCount(duration) {
	
	
	
		switch(duration){
	
	
	
			case "w":
	
	
	
				return 16;
	
	
	
			break;
	
	
	
			case "h":
	
	
	
				return 8;
	
	
	
			break;
	
	
	
			case "q":
	
	
	
				return 4;
	
	
	
			break;
	
	
	
			case "e":
	
	
	
				return 2;
	
	
	
			break;
	
	
	
			case "s":
	
	
	
				return 1;
	
	
	
			break;
	
	
	
			default:
	
	
	
				return 0;
	
	
	
		}
	
	
	
	}
	
	
	
	
	
	
	
	function refreshInput() {
	
	
	
		beats = [];
	
	
	
		const element = document.getElementById("inputCanvas");
	
	
	
		pitchDetectionCounter = 0;
	
	
	
		
	
	
	
		ctx = element.getContext("2d");
	
	
	
		ctx.clearRect(0,0,element.width,element.height);
	
	
	
		drawStaffLines();
	
	
	
		
	
	
	
		drawNotes();
	
	
	
	}
	
	
	
	
	
	
	
	</script>
	
	
	
	</body>
	
	
	
	</HTML>